"use strict";
/*!
* @project      suggestify-serverless
* @author      	Max van der Schee <hello@maxvanderschee.nl>
* @build        1628962902233
* @release      1.1.0
* @copyright    Copyright (c) 2021 Max van der Schee <hello@maxvanderschee.nl>
*/const e=3,t=8;async function s(s,r,n){const o=s.charAt(0),c=n[o]?n[o]:r,l={match:[],alt:[]};let i=[];const a=t=>{((e,t)=>{if(!e.length)return t.length;if(!t.length)return e.length;const s=[];for(let r=0;r<=t.length;r++){s[r]=[r];for(let n=1;n<=e.length;n++)s[r][n]=0===r?n:Math.min(s[r-1][n]+1,s[r][n-1]+1,s[r-1][n-1]+(e[n-1]===t[r-1]?0:1))}return s[t.length][e.length]})(t,s)<=e&&l.alt.push(t)};for(let e=0;e<c.length;e++)u=c[e],new RegExp(s.replace(/\W+/g,"|"),"i").test(u)&&l.match.push(u),a(c[e]);var u;const h=function(e,t){const s=[],r=new RegExp(t,"i"),n=new RegExp(`${t.replace(/\W+/g,"|")}`,"i"),o={},c=e.sort().filter((e=>{const t=r.exec(e);return!t||0!==t.index||(s.push(e),!1)})).filter((e=>!r.test(e)||(s.push(e),!1))).filter((e=>{const t=n.exec(e);return!t||(o[e]=t.index,!1)})),l=Object.keys(o).sort(((e,t)=>o[e]-o[t]));return[...s,...l,...c]}(l.match,s);return i=new Set([...h,...l.alt.sort()]),Promise.resolve([...i].slice(0,t))}const r=require("./items.json"),n=require("./sorted.json"),o=require("./suggestions.json"),c=require("lambda-rate-limiter")({interval:6e4,uniqueTokenPerInterval:500}),l=e=>e.length<=3?async function(e,s,r){const n=e.charAt(0),o=r[n]?r[n]:s,c=new RegExp(e.replace(/\W+/g,"|"),"i"),l=[];for(let i=0;i<o.length;i++){const e=c.exec(o[i]);if(e&&0===e.index&&l.push(o[i].toLowerCase()),l.length===t)break}return Promise.resolve(l.sort())}(e,r,n):s(e,r,n),i=e=>{const t={"&":"&amp;","<":"&lt;",">":"&gt;",'"':"&quot;","'":"&#x27;","`":"&grave;","/":"&#x2F;"};return e.replace(/[&<>"'/`]/gi,(e=>t[e]))};var a,u=(a=async(e,t)=>{const{headers:s,body:r}=e;let n;try{n=JSON.parse(r)}catch(u){n=r}const a=n.search?i(n.search.trim()):null;try{await c.check(50,s["x-real-ip"])}catch(h){return t.status(429).send("Too Many Requests")}if(!a)return t.status(200).json({type:"suggestions",items:o,time:0});try{let e=process.hrtime();const s=await l(a.toLowerCase());let r=process.hrtime(e);return t.status(200).json({type:s.length?"results":"empty",items:s,time:(1e9*r[0]+r[1])/1e9})}catch(h){return t.status(500).send("Woopsie, we will look into it!")}},async(e,t)=>{const s=e.headers.origin;return["http://localhost:3000","https://suggestify.maxvanderschee.nl"].indexOf(s)>-1&&t.setHeader("Access-Control-Allow-Origin",s),t.setHeader("Access-Control-Allow-Credentials",!0),t.setHeader("Access-Control-Allow-Methods","POST"),t.setHeader("Access-Control-Allow-Headers","X-CSRF-Token, X-Requested-With, Accept, Accept-Version, Content-Length, Content-MD5, Content-Type, Date, X-Api-Version"),await a(e,t)});module.exports=u;
