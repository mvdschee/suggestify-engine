"use strict";
/*!
* @project      suggestify-serverless
* @author      	Max van der Schee <hello@maxvanderschee.nl>
* @build        1628756648609
* @release      1.0.0
* @copyright    Copyright (c) 2021 Max van der Schee <hello@maxvanderschee.nl>
*/const e=8;async function t(t,s,r){const n={match:[],alt:[]},o=t.charAt(0);let c=[];const i=e=>{new RegExp(t.replace(/\W+/g,"|"),"i").test(e)&&n.match.push(e.toLowerCase())};if(r[o])for(let e=0;e<r[o].length;e++)i(r[o][e]);else for(let e=0;e<words.length;e++)i(s[e]);const l=function(e,t){const s=[],r=new RegExp(t,"i"),n=new RegExp(`${t.replace(/\W+/g,"|")}`,"i"),o={},c=e.sort().filter((e=>{const t=r.exec(e);return!t||0!==t.index||(s.push(e),!1)})).filter((e=>!r.test(e)||(s.push(e),!1))).filter((e=>{const t=n.exec(e);return!t||(o[e]=t.index,!1)})),i=Object.keys(o).sort(((e,t)=>o[e]-o[t]));return[...s,...i,...c]}(n.match,t);return c=new Set([...l,...n.alt.sort()]),Promise.resolve([...c].slice(0,e))}const s=require("./items.json"),r=require("./sorted.json"),n=require("./suggestions.json"),o=require("lambda-rate-limiter")({interval:6e4,uniqueTokenPerInterval:500}),c=n=>n.length<=3?async function(t,s,r){const n=[],o=t.charAt(0),c=new RegExp(t.replace(/\W+/g,"|"),"i");if(r[o])for(let i=0;i<r[o].length;i++){const t=r[o][i],s=c.exec(t);if(s&&0===s.index&&n.push(t.toLowerCase()),n.length===e)break}else for(let i=0;i<s.length;i++){const t=c.exec(s[i]);if(t&&0===t.index&&n.push(s[i].toLowerCase()),n.length===e)break}return Promise.resolve(n.sort())}(n,s,r):t(n,s,r),i=e=>{const t={"&":"&amp;","<":"&lt;",">":"&gt;",'"':"&quot;","'":"&#x27;","`":"&grave;","/":"&#x2F;"};return e.replace(/[&<>"'/`]/gi,(e=>t[e]))};var l,a=(l=async(e,t)=>{const{headers:s,body:r}=e,l=JSON.parse(r),a=l.search?i(l.search.trim()):null;try{await o.check(50,s["x-real-ip"])}catch(u){return t.status(429).send("Too Many Requests")}if(!a)return t.status(200).json({type:"suggestions",items:n,time:0});try{let e=process.hrtime();const s=await c(a.toLowerCase());let r=process.hrtime(e);return console.log((1e9*r[0]+r[1])/1e9),t.status(200).json({type:s.length?"results":"empty",items:s,time:(1e9*r[0]+r[1])/1e9})}catch(u){return t.status(500).send("Woopsie, we will look into it!")}},async(e,t)=>{const s=e.headers.origin;return["http://localhost:3000","https://suggestify.maxvanderschee.nl"].indexOf(s)>-1&&t.setHeader("Access-Control-Allow-Origin",s),t.setHeader("Access-Control-Allow-Credentials",!0),t.setHeader("Access-Control-Allow-Methods","POST"),t.setHeader("Access-Control-Allow-Headers","X-CSRF-Token, X-Requested-With, Accept, Accept-Version, Content-Length, Content-MD5, Content-Type, Date, X-Api-Version"),await l(e,t)});module.exports=a;
