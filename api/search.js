"use strict";
/*!
* @project      suggestify-serverless
* @author      	Max van der Schee <hello@maxvanderschee.nl>
* @build        1629013987501
* @release      1.1.0
* @copyright    Copyright (c) 2021 Max van der Schee <hello@maxvanderschee.nl>
*/const e=3,t=8;async function s(s,r,n){const o=s.charAt(0),l=n[o]?n[o]:r,c={match:[],alt:[]};let a=[];const i=t=>{((e,t)=>{if(!e.length)return t.length;if(!t.length)return e.length;const s=[];for(let r=0;r<=t.length;r++){s[r]=[r];for(let n=1;n<=e.length;n++)s[r][n]=0===r?n:Math.min(s[r-1][n]+1,s[r][n-1]+1,s[r-1][n-1]+(e[n-1]===t[r-1]?0:1))}return s[t.length][e.length]})(t,s)<=e&&c.alt.push(t)};for(let e=0;e<l.length;e++)h=l[e],new RegExp(s.replace(/\W+/g,"|"),"i").test(h)&&c.match.push(h);var h;if(c.match.length<=t)for(let e=0;e<l.length;e++)i(l[e]);const u=function(e,t){const s=[],r=new RegExp(t,"i"),n=new RegExp(`${t.replace(/\W+/g,"|")}`,"i"),o={},l=e.sort().filter((e=>{const t=r.exec(e);return!t||0!==t.index||(s.push(e),!1)})).filter((e=>!r.test(e)||(s.push(e),!1))).filter((e=>{const t=n.exec(e);return!t||(o[e]=t.index,!1)})),c=Object.keys(o).sort(((e,t)=>o[e]-o[t]));return[...s,...c,...l]}(c.match,s);return a=new Set([...u,...c.alt.sort()]),Promise.resolve([...a].slice(0,t))}const r=require("./items.json"),n=require("./sorted.json"),o=require("./suggestions.json"),l=require("lambda-rate-limiter")({interval:6e4,uniqueTokenPerInterval:500}),c=e=>{const t={"&":"&amp;","<":"&lt;",">":"&gt;",'"':"&quot;","'":"&#x27;","`":"&grave;","/":"&#x2F;"};return e.replace(/[&<>"'/`]/gi,(e=>t[e]))};var a,i=(a=async(e,t)=>{const{headers:a,body:i}=e;let h;try{h=JSON.parse(i)}catch(g){h=i}const u=h.search?c(h.search.trim()):null;try{await l.check(50,a["x-real-ip"])}catch(p){return t.status(429).send("Too Many Requests")}if(!u)return t.status(200).json({type:"suggestions",items:o,time:0});try{let e=process.hrtime();const o=await s(u.toLowerCase(),r,n);let l=process.hrtime(e);return console.log("total:",(1e9*l[0]+l[1])/1e9),t.status(200).json({type:o.length?"results":"empty",items:o,time:(1e9*l[0]+l[1])/1e9})}catch(p){return t.status(500).send("Woopsie, we will look into it!")}},async(e,t)=>{const s=e.headers.origin;return["http://localhost:3000","https://suggestify.maxvanderschee.nl"].indexOf(s)>-1&&t.setHeader("Access-Control-Allow-Origin",s),t.setHeader("Access-Control-Allow-Credentials",!0),t.setHeader("Access-Control-Allow-Methods","POST"),t.setHeader("Access-Control-Allow-Headers","X-CSRF-Token, X-Requested-With, Accept, Accept-Version, Content-Length, Content-MD5, Content-Type, Date, X-Api-Version"),await a(e,t)});module.exports=i;
