"use strict";
/*!
* @project      suggestify-engine
* @author      	Max van der Schee <hello@maxvanderschee.nl>
* @build        1629051689689
* @release      1.2.0
* @copyright    Copyright (c) 2021 Max van der Schee <hello@maxvanderschee.nl>
*/const e={MIN_DISTANCE:3,ITEM_CAP:8,RATELIMIT_CAP:50,RATELIMIT_TEXT:"Too Many Requests",INTERNAL_ERROR:"Woopsie, we will look into it!",ALLOWED_ORIGINS:["http://localhost:3000","http://localhost:3001","https://suggestify.maxvanderschee.nl"],SANITIZE:{"&":"&amp;","<":"&lt;",">":"&gt;",'"':"&quot;","'":"&#x27;","`":"&grave;","/":"&#x2F;"}};async function t(t,s,r){const n=t.charAt(0),o=r[n]?r[n]:s,l=new RegExp(t.replace(/\W+/g,"|"),"i"),a={match:[],alt:[]},i=s=>{((e,t)=>{if(!e.length)return t.length;if(!t.length)return e.length;const s=[];for(let r=0;r<=t.length;r++){s[r]=[r];for(let n=1;n<=e.length;n++)s[r][n]=0===r?n:Math.min(s[r-1][n]+1,s[r][n-1]+1,s[r-1][n-1]+(e[n-1]===t[r-1]?0:1))}return s[t.length][e.length]})(s,t)<=e.MIN_DISTANCE&&a.alt.push(s)};for(let e=0;e<o.length;e++)c=o[e],l.test(c)&&a.match.push(c);var c;if(a.match.length<=e.ITEM_CAP)for(let e=0;e<o.length;e++)i(o[e]);const u=function(e,t){const s=[],r=new RegExp(t,"i"),n=new RegExp(t.replace(/\W+/g,"|"),"i"),o={},l=e.filter((e=>{const t=r.exec(e);return!t||0!==t.index||(s.push(e),!1)})).filter((e=>!r.test(e)||(s.push(e),!1))).filter((e=>{const t=n.exec(e);return!t||(o[e]=t.index,!1)})),a=Object.keys(o).sort(((e,t)=>o[e]-o[t]));return[...s,...a,...l]}(a.match,t),h=new Set([...u,...a.alt.sort()]);return Promise.resolve([...h].slice(0,e.ITEM_CAP))}const s=require("./data/default.json"),r=require("./data/sorted.json"),n=require("./data/recommended.json"),o=require("lambda-rate-limiter")({interval:6e4,uniqueTokenPerInterval:500}),l=t=>t.replace(/[&<>"'/`]/gi,(t=>e.SANITIZE[t])).trim().toLowerCase();var a,i=(a=async(a,i)=>{const{headers:c,query:u}=a;try{await o.check(e.RATELIMIT_CAP,c["x-real-ip"])}catch(A){return i.status(429).send(e.RATELIMIT_TEXT)}const h=u.q?l(u.q):null;if(!h)return i.status(200).json({type:"suggestions",items:n,time:"0ms"});try{let e=process.hrtime();const n=await t(h,s,r);let o=process.hrtime(e);return i.status(200).json({type:n.length?"results":"empty",items:n,time:`${(1e3*o[0]+o[1]/1e6).toFixed(2)}ms`})}catch(g){return i.status(500).send(e.INTERNAL_ERROR)}},async(t,s)=>{const r=t.headers.origin;return e.ALLOWED_ORIGINS.indexOf(r)>-1&&s.setHeader("Access-Control-Allow-Origin",r),s.setHeader("Access-Control-Allow-Credentials",!0),s.setHeader("Access-Control-Allow-Methods","POST"),s.setHeader("Access-Control-Allow-Headers","X-CSRF-Token, X-Requested-With, Accept, Accept-Version, Content-Length, Content-MD5, Content-Type, Date, X-Api-Version"),await a(t,s)});module.exports=i;
